<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Audio Flashcards</title>
    <style>
        :root {
            --primary-start: #667eea;
            --primary-end: #764ba2;
            --accent-start: #ff6b6b;
            --accent-end: #ff8e53;
            --quiz-start: #ff9a9e;
            --quiz-end: #fecfef;
            --play-start: #4facfe;
            --play-end: #00f2fe;
            --correct-start: #48bb78;
            --correct-end: #68d391;
            --incorrect-start: #f56565;
            --incorrect-end: #fc8181;
            --new-color: #ffa500;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        /* New Style for main controls container to match card area width */
        #mainControlsContainer {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 1200px;
            width: 100%; /* Ensure controls utilize available width */
        }
        
        .select-group {
            display: flex;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .select-group select {
            background: transparent;
            border: none;
            color: white;
            font-size: 0.9rem;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
        }

        .select-group select:focus {
            outline: none;
        }

        .select-group select option {
            background: var(--primary-end);
            color: white;
        }

        .btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 10px 18px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn.active {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.6);
            box-shadow: 0 0 10px rgba(255,255,255,0.3);
        }

        .btn-quiz-back {
            background: var(--primary-end);
            color: white;
            border-color: var(--primary-end);
        }

        .btn-quiz-back:hover {
            background: var(--primary-start);
            border-color: var(--primary-start);
        }
        
        .quiz-btn {
            background: linear-gradient(45deg, var(--quiz-start), var(--quiz-end));
            color: #333;
            font-weight: bold;
        }

        .play-all-btn {
            background: linear-gradient(45deg, var(--play-start), var(--play-end));
        }

        .stop-btn {
            background: linear-gradient(45deg, var(--accent-start), var(--accent-end));
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1200px;
            width: 100%;
            padding: 20px;
        }

        .card {
            width: 100%;
            height: 320px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s ease, opacity 0.5s ease;
            cursor: pointer;
        }

        .card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
        }

        .card-back {
            transform: rotateY(180deg);
            background: rgba(255,255,255,0.98);
        }

        .card-image {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-start), var(--play-start));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .word-english {
            font-size: 2rem;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
            text-align: center;
            direction: ltr;
        }

        .word-translation {
            font-size: 1.5rem;
            color: #2d3748;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 500;
        }

        .word-type {
            font-size: 0.9rem;
            color: #718096;
            background: rgba(113, 128, 150, 0.1);
            padding: 5px 12px;
            border-radius: 15px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .audio-btn {
            background: linear-gradient(45deg, var(--accent-start), var(--accent-end));
            color: white; border: none; padding: 10px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem;
            transition: all 0.3s ease; display: flex; align-items: center; gap: 8px;
        }

        .audio-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        /* Quiz Mode Styles */
        .quiz-input { width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1.2rem; text-align: center; outline: none; }
        .quiz-input:focus { border-color: var(--play-start); box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1); }
        .quiz-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .check-btn { flex: 1; background: linear-gradient(45deg, var(--correct-start), var(--correct-end)); color: white; border: none; padding: 10px; border-radius: 15px; cursor: pointer; font-size: 0.9rem; }
        .wrong-btn { flex: 1; background: linear-gradient(45deg, var(--incorrect-start), var(--incorrect-end)); color: white; border: none; padding: 10px; border-radius: 15px; cursor: pointer; font-size: 0.9rem; }
        .quiz-result { margin-top: 10px; padding: 8px; border-radius: 10px; text-align: center; font-weight: bold; }
        .correct { background: #c6f6d5; color: #2f855a; }
        .incorrect { background: #fed7d7; color: #c53030; }

        .card.hidden { display: none; }

        .stats {
            background: rgba(255,255,255,0.1); color: white; padding: 15px 25px; border-radius: 15px; margin-bottom: 20px; text-align: center; backdrop-filter: blur(10px); font-size: 0.9rem;
        }

        .card-number {
            position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.1); color: #666; padding: 3px 8px; border-radius: 10px; font-size: 0.8rem;
        }
        
        .new-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: var(--new-color);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            transform: rotate(15deg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* Notification Toast */
        .toast-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: #333; color: white; padding: 15px 25px; border-radius: 10px; z-index: 2000; opacity: 0; visibility: hidden; transition: opacity 0.3s, top 0.3s, visibility 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .toast-notification.show { top: 40px; opacity: 1; visibility: visible; }
        
        /* New Quiz and Results Page Styles */
        .hidden {
            display: none !important;
        }

        .page-container {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            color: #333;
        }

        .quiz-header, .results-header {
            text-align: center;
            margin-bottom: 25px;
            font-size: 2rem;
            color: var(--primary-end);
        }

        .quiz-item {
            display: grid;
            grid-template-columns: auto 1fr;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .quiz-item:last-child {
            border-bottom: none;
        }

        .quiz-item-emoji {
            font-size: 3rem;
            width: 60px;
            text-align: center;
            grid-row: 1 / 3;
        }

        .quiz-item-word {
            font-size: 1.5rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            color: var(--primary-start);
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 4px;
            font-weight: bold; /* Make the word bold */
        }
        
        .letter-placeholder {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 40px;
            border: 2px solid var(--primary-end);
            border-radius: 5px;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-start);
            background-color: #fff;
        }

        .letter-choices {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .letter-btn {
            width: 40px;
            height: 40px;
            font-size: 1.2rem;
            border: 2px solid #ccc;
            border-radius: 8px;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .letter-btn:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .clear-selection-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--incorrect-start);
        }

        .finish-quiz-btn-container {
            text-align: center;
            margin-top: 30px;
        }

        .results-summary {
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .results-summary strong {
            font-size: 2rem;
            color: var(--correct-start);
        }

        .results-section {
            margin-top: 25px;
        }

        .results-section h3 {
            font-size: 1.3rem;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        .results-section.incorrect h3 {
            border-bottom: 2px solid var(--incorrect-start);
            color: var(--incorrect-start);
        }

        .results-section.correct h3 {
            border-bottom: 2px solid var(--correct-start);
            color: var(--correct-start);
        }

        .result-item {
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        .result-item .user-answer {
            color: var(--incorrect-end);
            font-weight: bold;
            margin-left: 10px;
        }
        .result-item .correct-answer {
            color: var(--correct-end);
            font-weight: bold;
        }

        .results-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }


        @media (max-width: 768px) {
            /* General Mobile adjustments */
            .cards-container { grid-template-columns: 1fr; gap: 15px; }
            .card { height: 280px; } 
            .header h1 { font-size: 2rem; } 
            .word-english { font-size: 1.8rem; }
            .word-translation { font-size: 1.3rem; } 
            .controls { 
                gap: 8px; 
                padding: 0 5px; /* Added padding for controls to breathe */
                width: 100%;
            } 
            .btn { padding: 8px 14px; font-size: 0.8rem; }
            
            /* Enhanced Select Group Responsiveness */
            .select-group {
                flex-direction: column; /* Stack dropdowns and labels vertically on mobile */
                width: 90%;
                margin: 0 auto;
                padding: 15px; 
                align-items: stretch; /* Stretch to make full width use */
            }
            .select-group label {
                padding: 5px 0 0 10px !important; /* Adjust label spacing */
                text-align: left; /* Align labels left */
            }
            .select-group select {
                font-size: 1rem;
                padding: 10px;
            }

            /* Quiz Mode Mobile Fixes */
            .quiz-item { grid-template-columns: 1fr; text-align: center;}
            .quiz-item-emoji { grid-row: 1; margin: 0 auto; }
            .quiz-item-word { justify-content: center; }
            .letter-choices { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéì English Audio Flashcards</h1>
        <p>Your personalized English learning journey</p>
    </div>

    <div id="mainControlsContainer">
        <div class="stats" id="stats">Loading stats...</div>
        
        <div class="controls">
            <div class="select-group">
                <label for="categorySelect" style="color: white; padding: 5px;">Category:</label>
                <select id="categorySelect"></select>
                <label for="lessonSelect" style="color: white; padding: 5px;">Lesson:</label>
                <select id="lessonSelect"></select>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn quiz-btn" onclick="toggleQuizMode()">üìù Listening Quiz</button>
            <button class="btn quiz-btn" onclick="startSpellingQuiz()">‚úçÔ∏è Spelling Quiz</button>
            <button class="btn" onclick="flipAllCards()">üîÑ Flip All</button>
            <button class="btn play-all-btn" id="playAllBtn" onclick="togglePlayAll()">üéµ Play All</button>
        </div>

        <div class="controls">
            <button class="btn voice-btn active" onclick="setVoice('american')" id="americanBtn">üá∫üá∏ American</button>
            <button class="btn voice-btn" onclick="setVoice('british')" id="britishBtn">üá¨üáß British</button>
        </div>
    </div>
    
    <div id="mainPageContainer">
        <div class="cards-container" id="cardsContainer"></div>
    </div>

    <div id="quizPageContainer" class="page-container hidden"></div>

    <div id="resultsPageContainer" class="page-container hidden"></div>
    
    <div id="toast" class="toast-notification"></div>

    <script type="module">
        const wordSets = {
            "General Vocabulary": {
                "Classroom Commands": [
                    { english: "close your book", translation: "ÿßŸÇŸÅŸÑ ŸÉÿ™ÿßÿ®ŸÉ", type: "command", emoji: "üìñ" },
                    { english: "open", translation: "ÿßŸÅÿ™ÿ≠", type: "verb", emoji: "üìÇ" },
                    { english: "sit down", translation: "ÿßÿ¨ŸÑÿ≥", type: "command", emoji: "üí∫" },
                    { english: "stand up", translation: "ŸÇŸÅ", type: "command", emoji: "üßç" },
                    { english: "raise hand", translation: "ÿßÿ±ŸÅÿπ ŸäÿØŸÉ", type: "command", emoji: "üôã" },
                ],
                "Colors": [
                    { english: "colors", translation: "ÿ£ŸÑŸàÿßŸÜ", type: "noun", emoji: "üåà" },
                    { english: "blue", translation: "ÿ£ÿ≤ÿ±ŸÇ", type: "adjective", emoji: "üíô" },
                    { english: "green", translation: "ÿ£ÿÆÿ∂ÿ±", type: "adjective", emoji: "üíö" },
                    { english: "red", translation: "ÿ£ÿ≠ŸÖÿ±", type: "adjective", emoji: "‚ù§Ô∏è" },
                    { english: "yellow", translation: "ÿ£ÿµŸÅÿ±", type: "adjective", emoji: "üíõ" },
                    { english: "orange", translation: "ÿ®ÿ±ÿ™ŸÇÿßŸÑŸä", type: "adjective", emoji: "üß°" },
                ],
                "Shapes": [
                    { english: "shapes", translation: "ÿ£ÿ¥ŸÉÿßŸÑ", type: "noun", emoji: "üî∑" },
                    { english: "triangle", translation: "ŸÖÿ´ŸÑÿ´", type: "noun", emoji: "üî∫" },
                    { english: "square", translation: "ŸÖÿ±ÿ®ÿπ", type: "noun", emoji: "‚¨ú" },
                    { english: "circle", translation: "ÿØÿßÿ¶ÿ±ÿ©", type: "noun", emoji: "‚≠ï" },
                ],
                "Action Verbs": [
                    { english: "kick", translation: "Ÿäÿ±ŸÉŸÑ", type: "verb", emoji: "ü¶µ" },
                    { english: "run", translation: "Ÿäÿ¨ÿ±Ÿä", type: "verb", emoji: "üèÉ‚Äç‚ôÇÔ∏è" },
                    { english: "throw", translation: "Ÿäÿ±ŸÖŸä", type: "verb", emoji: "ü§æ‚Äç‚ôÇÔ∏è" },
                    { english: "hear", translation: "Ÿäÿ≥ŸÖÿπ", type: "verb", emoji: "üëÇ" },
                    { english: "eat", translation: "Ÿäÿ£ŸÉŸÑ", type: "verb", emoji: "üçΩÔ∏è" },
                    { english: "touch", translation: "ŸäŸÑŸÖÿ≥", type: "verb", emoji: "‚úã" },
                    { english: "sing", translation: "Ÿäÿ∫ŸÜŸä", type: "verb", emoji: "üé§" },
                    { english: "read", translation: "ŸäŸÇÿ±ÿ£", type: "verb", emoji: "üìñ" },
                    { english: "swim", translation: "Ÿäÿ≥ÿ®ÿ≠", type: "verb", emoji: "üèä‚Äç‚ôÇÔ∏è" },
                    { english: "write", translation: "ŸäŸÉÿ™ÿ®", type: "verb", emoji: "‚úçÔ∏è" },
                    { english: "clean", translation: "ŸäŸÜÿ∏ŸÅ", type: "verb", emoji: "üßΩ" },
                    { english: "draw", translation: "Ÿäÿ±ÿ≥ŸÖ", type: "verb", emoji: "üé®" },
                    { english: "play", translation: "ŸäŸÑÿπÿ®", type: "verb", emoji: "üéÆ" },
                ],
                "Nouns": [
                    { english: "hand", translation: "ŸäÿØ", type: "noun", emoji: "‚úã" },
                    { english: "picture", translation: "ÿµŸàÿ±ÿ©", type: "noun", emoji: "üñºÔ∏è" }
                ]
            },
            "Our World - Book 1": {
                "Unit 1: Fun in Class": [
                    { english: "reading", translation: "ŸÇÿ±ÿßÿ°ÿ©", type: "verb", emoji: "üìñ", isNew: true },
                    { english: "counting", translation: "ÿπÿØ", type: "verb", emoji: "üî¢", isNew: true },
                    { english: "colouring", translation: "ÿ™ŸÑŸàŸäŸÜ", type: "verb", emoji: "üñçÔ∏è", isNew: true },
                    { english: "listening", translation: "ÿßÿ≥ÿ™ŸÖÿßÿπ", type: "verb", emoji: "üéß", isNew: true },
                    { english: "cutting", translation: "ŸÇÿµ", type: "verb", emoji: "‚úÇÔ∏è", isNew: true },
                    { english: "writing", translation: "ŸÉÿ™ÿßÿ®ÿ©", type: "verb", emoji: "‚úçÔ∏è", isNew: true },
                    { english: "drawing", translation: "ÿ±ÿ≥ŸÖ", type: "verb", emoji: "üé®", isNew: true },
                    { english: "gluing", translation: "ŸÑÿµŸÇ", type: "verb", emoji: "üß¥", isNew: true },
                    { english: "talking", translation: "ÿ™ÿ≠ÿØÿ´", type: "verb", emoji: "üí¨", isNew: true },
                    { english: "rubbing out", translation: "ŸÖÿ≠Ÿà", type: "verb", emoji: "üßº", isNew: true },
                    { english: "glue", translation: "ÿµŸÖÿ∫", type: "noun", emoji: "üß¥", isNew: true },
                    { english: "a notebook", translation: "ÿØŸÅÿ™ÿ±", type: "noun", emoji: "üìì", isNew: true },
                    { english: "a felt tip", translation: "ŸÇŸÑŸÖ ŸÅŸÑŸàŸÖÿßÿ≥ÿ™ÿ±", type: "noun", emoji: "üñäÔ∏è", isNew: true },
                    { english: "scissors", translation: "ŸÖŸÇÿµ", type: "noun", emoji: "‚úÇÔ∏è", isNew: true },
                    { english: "a paintbrush", translation: "ŸÅÿ±ÿ¥ÿßÿ© ÿ±ÿ≥ŸÖ", type: "noun", emoji: "üñåÔ∏è", isNew: true }
                ],
                "Unit 2 ‚Äì The World of Weather": [
                    { english: "a raincoat", translation: "ŸÖÿπÿ∑ŸÅ ŸàÿßŸÇŸç ŸÖŸÜ ÿßŸÑŸÖÿ∑ÿ±", type: "noun", emoji: "üß•", isNew: true },
                    { english: "a swimming costume", translation: "ŸÖŸÑÿßÿ®ÿ≥ ÿßŸÑÿ≥ÿ®ÿßÿ≠ÿ©", type: "noun", emoji: "üèä", isNew: true },
                    { english: "a jumper", translation: "ÿ≥ÿ™ÿ±ÿ© ÿµŸàŸÅŸäÿ© (ÿ®ŸÑŸàŸÅÿ±)", type: "noun", emoji: "üß∂", isNew: true },
                    { english: "boots", translation: "ÿ£ÿ≠ÿ∞Ÿäÿ© ÿ∑ŸàŸäŸÑÿ© ÿ™Ÿèÿ∫ÿ∑Ÿä ÿßŸÑŸÇÿØŸÖ ŸàÿßŸÑÿ≥ÿßŸÇ", type: "noun", emoji: "üë¢", isNew: true },
                    { english: "gloves", translation: "ŸÇŸÅÿßÿ≤ÿßÿ™", type: "noun", emoji: "üß§", isNew: true },
                    { english: "a hat", translation: "ŸÇÿ®ÿπÿ©", type: "noun", emoji: "üß¢", isNew: true },
                    { english: "a jacket", translation: "ÿ¨ÿßŸÉŸäÿ™ (ŸÖÿπÿ∑ŸÅ ŸÇÿµŸäÿ±)", type: "noun", emoji: "üß•", isNew: true },
                    { english: "trousers", translation: "ÿ®ŸÜÿ∑ÿßŸÑ", type: "noun", emoji: "üëñ", isNew: true },
                    { english: "cloudy", translation: "ÿ∫ÿßÿ¶ŸÖ", type: "adjective", emoji: "‚òÅÔ∏è", isNew: true },
                    { english: "rainy", translation: "ŸÖŸÖÿ∑ÿ±", type: "adjective", emoji: "üåßÔ∏è", isNew: true },
                    { english: "hot", translation: "ÿ≠ÿßÿ±", type: "adjective", emoji: "üî•", isNew: true },
                    { english: "sunny", translation: "ŸÖÿ¥ŸÖÿ≥", type: "adjective", emoji: "‚òÄÔ∏è", isNew: true },
                    { english: "windy", translation: "ÿπÿßÿµŸÅ / ÿ®Ÿá ÿ±Ÿäÿßÿ≠", type: "adjective", emoji: "üå¨Ô∏è", isNew: true },
                    { english: "cold", translation: "ÿ®ÿßÿ±ÿØ", type: "adjective", emoji: "ü•∂", isNew: true },
                    { english: "snowy", translation: "ŸÖÿ´ŸÑÿ¨", type: "adjective", emoji: "‚ùÑÔ∏è", isNew: true },
                    { english: "shorts", translation: "ÿ¥Ÿàÿ±ÿ™ / ÿ≥ÿ±ŸàÿßŸÑ ŸÇÿµŸäÿ±", type: "noun", emoji: "ü©≥", isNew: true },
                    { english: "trainers", translation: "ÿ£ÿ≠ÿ∞Ÿäÿ© ÿ±Ÿäÿßÿ∂Ÿäÿ©", type: "noun", emoji: "üëü", isNew: true },
                    { english: "umbrella", translation: "ŸÖÿ∏ŸÑÿ© / ÿ¥ŸÖÿ≥Ÿäÿ©", type: "noun", emoji: "‚òî", isNew: true },
                    { english: "jeans", translation: "ÿ®ŸÜÿ∑ÿßŸÑ ÿ¨ŸäŸÜÿ≤", type: "noun", emoji: "üëñ", isNew: true },
                    { english: "a coat", translation: "ŸÖÿπÿ∑ŸÅ", type: "noun", emoji: "üß•", isNew: true }
                ],
                "Unit 3 ‚Äì Fun in the Sun": [
                    { english: "skip", translation: "ŸäŸÇŸÅÿ≤ ÿ®ÿÆŸÅÿ© Ÿàÿ≥ÿ±ÿπÿ©", type: "verb", emoji: "ü§∏", isNew: true },
                    { english: "play basketball", translation: "ŸäŸÑÿπÿ® ŸÉÿ±ÿ© ÿßŸÑÿ≥ŸÑÿ©", type: "verb", emoji: "üèÄ", isNew: true },
                    { english: "play a game", translation: "ŸäŸÑÿπÿ® ŸÑÿπÿ®ÿ©", type: "verb", emoji: "üé≤", isNew: true },
                    { english: "ride a bike", translation: "Ÿäÿ±ŸÉÿ® ÿØÿ±ÿßÿ¨ÿ©", type: "verb", emoji: "üö¥", isNew: true },
                    { english: "rollerblade", translation: "Ÿäÿ™ÿ≤ŸÑÿ¨ ÿπŸÑŸâ ÿ£ÿ≠ÿ∞Ÿäÿ© ÿ®ÿπÿ¨ŸÑÿßÿ™", type: "verb", emoji: "üõº", isNew: true },
                    { english: "play football", translation: "ŸäŸÑÿπÿ® ŸÉÿ±ÿ© ÿßŸÑŸÇÿØŸÖ", type: "verb", emoji: "‚öΩ", isNew: true },
                    { english: "play baseball", translation: "ŸäŸÑÿπÿ® ÿßŸÑÿ®Ÿäÿ≥ÿ®ŸàŸÑ", type: "verb", emoji: "‚öæ", isNew: true },
                    { english: "skateboard", translation: "Ÿäÿ™ÿ≤ŸÑÿ¨ ÿπŸÑŸâ ŸÑŸàÿ≠ ÿ∞Ÿä ÿπÿ¨ŸÑÿßÿ™", type: "verb", emoji: "üõπ", isNew: true },
                    { english: "play hide and seek", translation: "ŸäŸÑÿπÿ® ÿßŸÑÿ∫ŸÖŸäÿ∂ÿ©", type: "verb", emoji: "üôà", isNew: true },
                    { english: "fly a kite", translation: "Ÿäÿ∑Ÿäÿ± ÿ∑ÿßÿ¶ÿ±ÿ© Ÿàÿ±ŸÇŸäÿ©", type: "verb", emoji: "ü™Å", isNew: true },
                    { english: "bounce a ball", translation: "ŸäŸèÿ±ÿ™ÿØ ÿßŸÑŸÉÿ±ÿ©", type: "verb", emoji: "‚õπÔ∏è", isNew: true },
                    { english: "throw a ball", translation: "Ÿäÿ±ŸÖŸä ÿßŸÑŸÉÿ±ÿ©", type: "verb", emoji: "ü•é", isNew: true },
                    { english: "catch a ball", translation: "ŸäŸÖÿ≥ŸÉ ÿßŸÑŸÉÿ±ÿ©", type: "verb", emoji: "üß§", isNew: true },
                    { english: "watch a game", translation: "Ÿäÿ¥ÿßŸáÿØ ŸÖÿ®ÿßÿ±ÿßÿ©", type: "verb", emoji: "üì∫", isNew: true },
                    { english: "play tag", translation: "ŸäŸÑÿπÿ® ÿßŸÑÿ™ÿ∑ŸàŸäÿ¥", type: "verb", emoji: "üèÉ", isNew: true }
                ],
                "Unit 4 ‚Äì Inside Our House": [
                    { english: "a fireplace", translation: "ŸÖÿØŸÅÿ£ÿ©", type: "noun", emoji: "üî•", isNew: true },
                    { english: "a bookcase", translation: "ÿÆÿ≤ÿßŸÜÿ© ŸÉÿ™ÿ®", type: "noun", emoji: "üìö", isNew: true },
                    { english: "an armchair", translation: "ŸÖŸÇÿπÿØ ŸÖÿ±Ÿäÿ≠ ÿ®ÿ∞ÿ±ÿßÿπŸäŸÜ", type: "noun", emoji: "ü™ë", isNew: true },
                    { english: "stairs", translation: "ÿ≥ŸèŸÑŸëŸÖ (ÿØÿ±ÿ¨ÿßÿ™)", type: "noun", emoji: "ü™ú", isNew: true },
                    { english: "shelves", translation: "ÿ±ŸÅŸàŸÅ", type: "noun", emoji: "üñºÔ∏è", isNew: true },
                    { english: "a rug", translation: "ÿ≥ÿ¨ÿßÿØÿ© ÿµÿ∫Ÿäÿ±ÿ©", type: "noun", emoji: "üß∂", isNew: true },
                    { english: "a shower", translation: "ÿØÿ¥", type: "noun", emoji: "üöø", isNew: true },
                    { english: "a bath", translation: "ÿ≠Ÿàÿ∂ ÿßÿ≥ÿ™ÿ≠ŸÖÿßŸÖ", type: "noun", emoji: "üõÅ", isNew: true },
                    { english: "a microwave", translation: "ŸÖŸäŸÉÿ±ŸàŸàŸäŸÅ", type: "noun", emoji: "‚ô®Ô∏è", isNew: true },
                    { english: "a cooker", translation: "ŸÖŸàŸÇÿØ/ŸÅÿ±ŸÜ", type: "noun", emoji: "üç≥", isNew: true },
                    { english: "a fridge", translation: "ÿ´ŸÑÿßÿ¨ÿ©", type: "noun", emoji: "üßä", isNew: true },
                    { english: "a window", translation: "ŸÜÿßŸÅÿ∞ÿ©", type: "noun", emoji: "ü™ü", isNew: true },
                    { english: "a sink", translation: "ÿ≠Ÿàÿ∂ ÿ∫ÿ≥ŸÑ", type: "noun", emoji: "üö∞", isNew: true },
                    { english: "a phone", translation: "Ÿáÿßÿ™ŸÅ", type: "noun", emoji: "üì±", isNew: true },
                    { english: "a door", translation: "ÿ®ÿßÿ®", type: "noun", emoji: "üö™", isNew: true }
                ],
                "Unit 5 ‚Äì Day by Day": [
                    { english: "get up", translation: "ŸäŸÜŸáÿ∂ ŸÖŸÜ ÿßŸÑÿ≥ÿ±Ÿäÿ±", type: "verb", emoji: "üåÖ", isNew: true },
                    { english: "wash my face", translation: "ÿ£ÿ∫ÿ≥ŸÑ Ÿàÿ¨ŸáŸä", type: "verb", emoji: "üíß", isNew: true },
                    { english: "brush my teeth", translation: "ÿ£ŸÜÿ∏ŸÅ ÿ£ÿ≥ŸÜÿßŸÜŸä", type: "verb", emoji: "ü¶∑", isNew: true },
                    { english: "get dressed", translation: "ÿ£ÿ±ÿ™ÿØŸä ŸÖŸÑÿßÿ®ÿ≥Ÿä", type: "verb", emoji: "üëö", isNew: true },
                    { english: "have breakfast", translation: "ÿ£ÿ™ŸÜÿßŸàŸÑ Ÿàÿ¨ÿ®ÿ© ÿßŸÑÿ•ŸÅÿ∑ÿßÿ±", type: "verb", emoji: "üßá", isNew: true },
                    { english: "go to school", translation: "ÿ£ÿ∞Ÿáÿ® ÿ•ŸÑŸâ ÿßŸÑŸÖÿØÿ±ÿ≥ÿ©", type: "verb", emoji: "üéí", isNew: true },
                    { english: "have lunch", translation: "ÿ£ÿ™ŸÜÿßŸàŸÑ ÿßŸÑÿ∫ÿØÿßÿ°", type: "verb", emoji: "ü•™", isNew: true },
                    { english: "play with friends", translation: "ÿ£ŸÑÿπÿ® ŸÖÿπ ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°", type: "verb", emoji: "ü§ù", isNew: true },
                    { english: "play computer games", translation: "ÿ£ŸÑÿπÿ® ÿ£ŸÑÿπÿßÿ® ÿßŸÑŸÉŸÖÿ®ŸäŸàÿ™ÿ±", type: "verb", emoji: "üéÆ", isNew: true },
                    { english: "have dinner", translation: "ÿ£ÿ™ŸÜÿßŸàŸÑ ÿßŸÑÿπÿ¥ÿßÿ°", type: "verb", emoji: "üç≤", isNew: true },
                    { english: "go to bed", translation: "ÿ£ÿ∞Ÿáÿ® ÿ•ŸÑŸâ ÿßŸÑÿ≥ÿ±Ÿäÿ±", type: "verb", emoji: "üõå", isNew: true },
                    { english: "in the morning", translation: "ŸÅŸä ÿßŸÑÿµÿ®ÿßÿ≠", type: "time", emoji: "üå§Ô∏è", isNew: true },
                    { english: "late", translation: "ŸÖÿ™ÿ£ÿÆÿ±", type: "adjective", emoji: "‚è≥", isNew: true },
                    { english: "in the afternoon", translation: "ŸÅŸä ŸÅÿ™ÿ±ÿ© ÿ®ÿπÿØ ÿßŸÑÿ∏Ÿáÿ±", type: "time", emoji: "‚òÄÔ∏è", isNew: true },
                    { english: "in the evening", translation: "ŸÅŸä ÿßŸÑŸÖÿ≥ÿßÿ°", type: "time", emoji: "üåÜ", isNew: true },
                    { english: "at night", translation: "ŸÅŸä ÿßŸÑŸÑŸäŸÑ", type: "time", emoji: "üåÉ", isNew: true }
                ]
            }
        };

        let currentFlashcards = [];
        let isPlayingAll = false;
        let isQuizMode = false;
        let currentVoice = 'american';

        // --- App State and Elements ---
        const categorySelect = document.getElementById('categorySelect');
        const lessonSelect = document.getElementById('lessonSelect');
        const mainControlsContainer = document.getElementById('mainControlsContainer');
        const mainPageContainer = document.getElementById('mainPageContainer');
        const quizPageContainer = document.getElementById('quizPageContainer');
        const resultsPageContainer = document.getElementById('resultsPageContainer');
        
        // --- UI Initialization and Rendering ---
        function initializeAppUI() {
            populateSelectors();
            loadLesson();
            setupEventListeners();
        }

        function renderUI() {
            isQuizMode ? createQuizCards() : createCards();
            updateStats();
        }

        function createCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            currentFlashcards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.id = `card-${card.english.replace(/\s+/g, '-')}`;
                
                cardElement.innerHTML = `
                    <div class="card-face card-front">
                        ${card.isNew ? '<div class="new-badge">New</div>' : ''}
                        <div class="card-number">${index + 1}</div>
                        <div class="card-image">${card.emoji}</div>
                        <div class="word-type">${card.type}</div>
                        <div class="word-english">${card.english}</div>
                        <button class="audio-btn" data-word="${card.english}">üîä Listen</button>
                    </div>
                    <div class="card-face card-back">
                        <div class="card-image">${card.emoji}</div>
                        <div class="word-english" style="font-size: 1.8rem;">${card.english}</div>
                        <div class="word-translation">${card.translation}</div>
                        <button class="audio-btn" data-word="${card.english}">üîä Listen Again</button>
                    </div>
                `;
                container.appendChild(cardElement);
            });
        }
        
        function createQuizCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            currentFlashcards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'card';
                cardElement.id = `card-${card.english.replace(/\s+/g, '-')}`;
                cardElement.innerHTML = `
                    <div class="card-face quiz-face">
                        <div class="card-number">${index + 1}</div>
                        <div class="card-image">${card.emoji}</div>
                        <button class="audio-btn" data-word="${card.english}" style="margin-bottom: 15px;">üîä Listen</button>
                        <input type="text" class="quiz-input" placeholder="Type the English word..." data-answer="${card.english.toLowerCase()}" data-index="${index}" dir="ltr">
                        <div class="quiz-buttons">
                            <button class="check-btn" data-index="${index}">‚úì Check</button>
                            <button class="wrong-btn" data-index="${index}">‚ùå Show Answer</button>
                        </div>
                        <div class="quiz-result" id="result-${index}"></div>
                    </div>
                `;
                container.appendChild(cardElement);
            });
        }
        
        // --- Event Handling & UI Logic ---
        function setupEventListeners() {
            categorySelect.addEventListener('change', populateLessons);
            lessonSelect.addEventListener('change', loadLesson);
            document.getElementById('cardsContainer').addEventListener('click', handleCardClick);
            quizPageContainer.addEventListener('click', handleQuizInteraction);
        }
        
        function handleCardClick(e) {
            const cardElement = e.target.closest('.card');
            if (!cardElement) return;

            if (e.target.matches('.audio-btn')) {
                e.stopPropagation(); playAudio(e.target.dataset.word); return;
            }
            if (isQuizMode) {
                const index = e.target.dataset.index;
                if (e.target.matches('.check-btn')) checkAnswer(index);
                else if (e.target.matches('.wrong-btn')) showAnswer(index);
                return;
            }
            if (!isQuizMode) cardElement.classList.toggle('flipped');
        }

        function populateSelectors() {
            categorySelect.innerHTML = '';
            for (const category in wordSets) {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                categorySelect.appendChild(option);
            }
            populateLessons();
        }

        function populateLessons() {
            const selectedCategory = categorySelect.value;
            lessonSelect.innerHTML = '';
            for (const lesson in wordSets[selectedCategory]) {
                const option = document.createElement('option');
                option.value = lesson;
                option.textContent = lesson;
                lessonSelect.appendChild(option);
            }
            loadLesson();
        }

        function loadLesson() {
            const selectedCategory = categorySelect.value;
            const selectedLesson = lessonSelect.value;
            currentFlashcards = [...wordSets[selectedCategory][selectedLesson]];
            renderUI();
        }
        
        function playAudio(word) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = currentVoice === 'british' ? 'en-GB' : 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
            } else {
                showToast('Browser does not support speech synthesis');
            }
        }
        
        window.toggleQuizMode = function() {
            isQuizMode = !isQuizMode;
            document.querySelector('.quiz-btn').classList.toggle('active', isQuizMode);
            renderUI();
        }

        window.checkAnswer = function(index) {
            const input = document.querySelector(`input[data-index="${index}"]`);
            const result = document.getElementById(`result-${index}`);
            if (input.value.toLowerCase().trim() === input.dataset.answer) {
                result.textContent = '‚úÖ Correct! Well done!'; result.className = 'quiz-result correct';
            } else {
                result.innerHTML = `‚ùå Incorrect. The answer is: <strong>${currentFlashcards[index].english}</strong>`;
                result.className = 'quiz-result incorrect';
            }
        }

        window.showAnswer = function(index) {
            document.getElementById(`result-${index}`).innerHTML = `üí° Answer: <strong>${currentFlashcards[index].english}</strong>`;
        }
        
        window.flipAllCards = function() {
            if (isQuizMode) return;
            document.querySelectorAll('.card:not(.hidden)').forEach(card => card.classList.toggle('flipped'));
        }

        window.togglePlayAll = function() { isPlayingAll ? stopPlayAll() : playAllCards(); }
        
        function stopPlayAll() {
            isPlayingAll = false;
            speechSynthesis.cancel();
            document.getElementById('playAllBtn').classList.remove('stop-btn');
            document.querySelectorAll('.card').forEach(c => c.style.transform = '');
        }

        function playAllCards() {
            isPlayingAll = true;
            document.getElementById('playAllBtn').classList.add('stop-btn');
            const visibleCards = Array.from(document.querySelectorAll('.card:not(.hidden)'));
            let currentIndex = 0;
            
            function playNext() {
                if (currentIndex >= visibleCards.length || !isPlayingAll) return stopPlayAll();
                const cardElement = visibleCards[currentIndex];
                const word = cardElement.querySelector('.audio-btn').dataset.word;

                document.querySelectorAll('.card').forEach(c => c.style.transform = '');
                cardElement.style.transform = 'scale(1.05)';
                cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                const utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = currentVoice === 'british' ? 'en-GB' : 'en-US';
                utterance.rate = 0.7;
                utterance.onend = () => { if (isPlayingAll) setTimeout(playNext, 1200); };
                speechSynthesis.speak(utterance);
                currentIndex++;
            }
            playNext();
        }

        window.setVoice = function(voice) {
            currentVoice = voice;
            document.querySelectorAll('.voice-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(voice === 'american' ? 'americanBtn' : 'britishBtn').classList.add('active');
        }

        function updateStats() {
            const total = currentFlashcards.length;
            document.getElementById('stats').textContent = `Lesson Total: ${total}`;
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- New Spelling Quiz Functions ---

        function handleQuizInteraction(e) {
            const quizItem = e.target.closest('.quiz-item');
            if (!quizItem) return;

            if (e.target.matches('.letter-btn')) {
                const letter = e.target.textContent;
                const answerBoxes = quizItem.querySelectorAll('.letter-placeholder');
                const firstEmptyBox = Array.from(answerBoxes).find(box => !box.textContent);
                if (firstEmptyBox) {
                    firstEmptyBox.textContent = letter;
                    e.target.disabled = true;
                }
            } else if (e.target.matches('.clear-selection-btn')) {
                quizItem.querySelectorAll('.letter-placeholder').forEach(box => box.textContent = '');
                quizItem.querySelectorAll('.letter-btn').forEach(btn => btn.disabled = false);
            }
        }

        window.startSpellingQuiz = function() {
            mainPageContainer.classList.add('hidden');
            mainControlsContainer.classList.add('hidden');
            resultsPageContainer.classList.add('hidden');
            quizPageContainer.classList.remove('hidden');
            quizPageContainer.innerHTML = ''; // Clear previous quiz

            const selectedLesson = lessonSelect.options[lessonSelect.selectedIndex].text;
            let quizHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 class="quiz-header" style="margin: 0; flex-grow: 1;">Spelling Quiz: ${selectedLesson}</h2>
                    <button class="btn btn-quiz-back" onclick="backToMain()">Back</button>
                </div>`;

            currentFlashcards.forEach((card) => {
                const { wordWithBlanksHTML, missingLetters } = createWordWithBlanks(card.english);
                const choices = generateLetterChoices(missingLetters);
                
                quizHTML += `
                    <div class="quiz-item" data-correct-letters="${missingLetters.sort().join('')}">
                        <div class="quiz-item-emoji">${card.emoji}</div>
                        <div class="quiz-item-word">${wordWithBlanksHTML}</div>
                        <div class="letter-choices">
                            ${choices.map(choice => `<button class="letter-btn">${choice}</button>`).join('')}
                            <button class="clear-selection-btn">‚ôªÔ∏è</button>
                        </div>
                    </div>
                `;
            });

            quizHTML += `
                <div class="finish-quiz-btn-container">
                    <button class="btn quiz-btn" onclick="finishQuiz()">Finish Quiz</button>
                </div>
            `;

            quizPageContainer.innerHTML = quizHTML;
        }

        function createWordWithBlanks(word) {
            let chars = word.split('');
            let letterIndices = [];
            chars.forEach((char, index) => {
                if (char.match(/[a-zA-Z]/)) {
                    letterIndices.push(index);
                }
            });

            if (letterIndices.length < 2) {
                const html = chars.map(char => `<span>${char}</span>`).join('');
                return { wordWithBlanksHTML: html, missingLetters: [] };
            }

            const missingLetters = [];
            let indicesToRemove = new Set();
            while (indicesToRemove.size < 2) {
                const randomIndex = letterIndices[Math.floor(Math.random() * letterIndices.length)];
                indicesToRemove.add(randomIndex);
            }
            
            // Store missing letters before replacing them
            indicesToRemove.forEach(index => {
                missingLetters.push(chars[index]);
            });

            let wordWithBlanksHTML = '';
            chars.forEach((char, index) => {
                if (indicesToRemove.has(index)) {
                    wordWithBlanksHTML += `<span class="letter-placeholder"></span>`;
                } else {
                    wordWithBlanksHTML += `<span>${char === ' ' ? '&nbsp;' : char}</span>`;
                }
            });
            
            return { wordWithBlanksHTML, missingLetters };
        }

        function generateLetterChoices(missingLetters) {
            const choices = new Set(missingLetters.map(l => l.toLowerCase()));
            const alphabet = 'abcdefghijklmnopqrstuvwxyz';
            while (choices.size < 5) {
                const randomChar = alphabet[Math.floor(Math.random() * alphabet.length)];
                choices.add(randomChar);
            }
            return Array.from(choices).sort(() => Math.random() - 0.5); // Shuffle
        }


        window.finishQuiz = function() {
            const quizItems = quizPageContainer.querySelectorAll('.quiz-item');
            let score = 0;
            const correctAnswers = [];
            const incorrectAnswers = [];

            quizItems.forEach((item, index) => {
                const correctLetters = item.dataset.correctLetters.toLowerCase().split('').sort().join('');
                const selectedLetters = Array.from(item.querySelectorAll('.letter-placeholder')).map(box => box.textContent.toLowerCase()).sort().join('');
                const originalCard = currentFlashcards[index];
                
                if (selectedLetters === correctLetters) {
                    score++;
                    correctAnswers.push(originalCard.english);
                } else {
                    // Reconstruct the user's attempt on the missing letters for display
                    const userAttempt = Array.from(item.querySelectorAll('.letter-placeholder')).map(box => box.textContent || ' ').join('');
                    
                    incorrectAnswers.push({
                        word: originalCard.english,
                        // Show the reconstructed user answer based on the length of the blanks (which is always 2)
                        userAnswer: userAttempt
                    });
                }
            });

            displayResults(score, correctAnswers, incorrectAnswers);
        }

        function displayResults(score, correctAnswers, incorrectAnswers) {
            quizPageContainer.classList.add('hidden');
            resultsPageContainer.classList.remove('hidden');
            resultsPageContainer.innerHTML = '';

            const totalQuestions = currentFlashcards.length;
            let resultsHTML = `
                <h2 class="results-header">Quiz Results</h2>
                <div class="results-summary">
                    Your score: <strong>${score} / ${totalQuestions}</strong>
                </div>
            `;

            if (incorrectAnswers.length > 0) {
                resultsHTML += `
                    <div class="results-section incorrect">
                        <h3>Incorrect Answers</h3>
                        ${incorrectAnswers.map(item => `
                            <div class="result-item">
                               Correct word: <span class="correct-answer">${item.word}</span> | Your letters: <span class="user-answer">${item.userAnswer}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            if (correctAnswers.length > 0) {
                resultsHTML += `
                    <div class="results-section correct">
                        <h3>Correct Answers</h3>
                        ${correctAnswers.map(item => `<div class="result-item">‚úì ${item}</div>`).join('')}
                    </div>
                `;
            }

            resultsHTML += `
                <div class="results-buttons">
                    <button class="btn btn-quiz-back" onclick="backToMain()">Back to Main</button>
                    <button class="btn quiz-btn" onclick="retakeQuiz()">Retake Quiz</button>
                </div>
            `;

            resultsPageContainer.innerHTML = resultsHTML;
        }

        window.backToMain = function() {
            resultsPageContainer.classList.add('hidden');
            quizPageContainer.classList.add('hidden');
            mainPageContainer.classList.remove('hidden');
            mainControlsContainer.classList.remove('hidden');
        }

        window.retakeQuiz = function() {
            startSpellingQuiz();
        }


        // Initialize App
        initializeAppUI();

    </script>
</body>
</html>
